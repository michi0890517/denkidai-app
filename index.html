<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>電気代アプリ v3（週次トラッカー：先週/今週/来週）</title>
<link rel="manifest" href="manifest.webmanifest" />
<meta name="theme-color" content="#0b0f14" />
<style>
:root{--bg:#0b0f14;--panel:#111824;--text:#e8f0ff;--muted:#9fb3c8;--accent:#5ad1ff;--accent2:#7cffc2;--border:#233043;--ok:#64f4a3;--warn:#ffd36e;--bad:#ff6b6b}
*{box-sizing:border-box} body{margin:0;background:#0b0f14;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;line-height:1.6;padding-bottom:env(safe-area-inset-bottom)}
header{position:sticky;top:0;z-index:10;padding:16px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,rgba(90,209,255,.08),rgba(124,255,194,.05));backdrop-filter:blur(6px)}
h1{margin:0;font-size:clamp(18px,3.2vw,28px)} .sub{color:var(--muted);font-size:12px}
main{max-width:1200px;margin:0 auto;padding:16px} .grid{display:grid;gap:14px;grid-template-columns:1fr} @media(min-width:1100px){.grid{grid-template-columns:1.2fr 1fr}}
.card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));border:1px solid var(--border);border-radius:14px;padding:14px}
.row{display:flex;gap:10px;flex-wrap:wrap} label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
input,select,button,textarea{background:#0e1520;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px;outline:none}
input:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(90,209,255,.12)}
button{cursor:pointer;border:1px solid transparent;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#001018;font-weight:700}
button.secondary{background:transparent;color:var(--text);border-color:var(--border)}
table{width:100%;border-collapse:collapse;font-size:14px} th,td{border-bottom:1px dashed var(--border);padding:10px;text-align:left} th{color:var(--muted)}
.kpi{display:grid;grid-template-columns:repeat(2,1fr);gap:10px} @media(min-width:640px){.kpi{grid-template-columns:repeat(4,1fr)}}
.kpi .box{background:#0e1520;border:1px solid var(--border);border-radius:12px;padding:12px} .kpi .num{font-size:22px;font-weight:800}
.small{font-size:12px;color:var(--muted)} .tag{padding:4px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px;color:var(--muted);display:inline-block}
.flex-between{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
canvas{width:100%;height:320px;background:#0e1520;border:1px solid var(--border);border-radius:12px;display:block}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--border)}
@media (max-width: 640px){ input,select,button,textarea{font-size:16px} .row{gap:8px} .card{padding:12px}}
summary{cursor:pointer}
</style>
</head>
<body>
<header>
  <h1>電気代アプリ v3 <span class="badge">週次トラッカー</span> <span class="badge">先週/今週/来週</span></h1>
  <div class="sub">スマホ最適化・PWA対応。ホーム画面追加＆オフラインOK。</div>
</header>

<main class="grid">

  <!-- 入力 -->
  <section class="card">
    <div class="flex-between">
      <h2 style="margin:0">① クイック記録（プリセット & 上書き可）</h2>
      <span class="small">式: (W × 時間) ÷ 1000 = kWh、kWh × 単価 = 円</span>
    </div>
    <div class="row">
      <div>
        <label>家電プリセット</label>
        <select id="preset"></select>
      </div>
      <div>
        <label>家電名</label>
        <input id="name" placeholder="例: エアコン（冷房）">
      </div>
      <div>
        <label>消費電力 (W)</label>
        <input id="watt" type="number" inputmode="decimal" placeholder="600">
      </div>
      <div>
        <label>使用時間 (h)</label>
        <input id="hours" type="number" inputmode="decimal" placeholder="1.5">
      </div>
      <div>
        <label>単価 (円/kWh)</label>
        <input id="tariff" type="number" value="31">
      </div>
      <div>
        <label>日付</label>
        <input id="date" type="date">
      </div>
      <div>
        <label>カテゴリー</label>
        <select id="category">
          <option>冷暖房</option><option>キッチン</option><option>照明</option>
          <option>情報家電</option><option>娯楽・ゲーム</option><option>その他</option>
        </select>
      </div>
    </div>
    <div class="row" style="margin-top:6px">
      <button id="addRecord">この内容で記録</button>
      <button class="secondary" id="saveMyDevice">↑ をマイ家電に保存</button>
      <button class="secondary" id="clearMyDevice">マイ家電全消去</button>
      <button class="secondary" id="exportData">書き出し</button>
      <label for="importFile" class="secondary" style="display:inline-flex;align-items:center;gap:8px;cursor:pointer;width:auto;padding:10px 12px;border-radius:10px;border:1px solid var(--border)">
        <input type="file" id="importFile" accept=".json" style="display:none">取り込み
      </label>
    </div>
  </section>

  <!-- 週ビュー&KPI -->
  <section class="card">
    <div class="flex-between">
      <h2 style="margin:0">② 週ビュー（先週/今週/来週）</h2>
      <div class="row">
        <button class="secondary" id="prevWeek">＜ 先週</button>
        <button class="secondary" id="thisWeek">今週</button>
        <button class="secondary" id="nextWeek">来週 ＞</button>
        <input id="jumpDate" type="date" title="この日を含む週へジャンプ">
      </div>
    </div>
    <div class="flex-between" style="margin-top:8px">
      <div><span class="tag">週範囲</span> <strong id="weekLabel">—</strong></div>
      <div class="small">週の開始は<strong>月曜</strong>基準</div>
    </div>
    <div class="kpi" style="margin-top:10px">
      <div class="box"><div class="small">今週 合計kWh</div><div class="num" id="kpiKwh">0.00</div></div>
      <div class="box"><div class="small">今週 電気代</div><div class="num" id="kpiYen">¥0</div></div>
      <div class="box"><div class="small">先週比</div><div class="num" id="kpiWoW">—</div></div>
      <div class="box"><div class="small">来週予測</div><div class="num" id="kpiNext">¥0</div></div>
    </div>
  </section>

  <!-- 日別明細 -->
  <section class="card" style="grid-column:1/-1">
    <h2 style="margin:0 0 6px">③ 日別明細（今表示中の週）</h2>
    <table id="weekTable">
      <thead><tr><th>日付</th><th>kWh</th><th>電気代</th><th>内訳</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- グラフ -->
  <section class="card">
    <h2 style="margin:0 0 6px">④ 日別コスト（今週）</h2>
    <canvas id="barWeek"></canvas>
  </section>

  <section class="card">
    <h2 style="margin:0 0 6px">⑤ 先週/今週/来週（予測）</h2>
    <canvas id="barCompare"></canvas>
    <div class="small">来週は直近2週の平均×季節係数（任意：1.00）で予測</div>
    <div class="row" style="margin-top:6px">
      <div>
        <label>季節係数（冷暖房期など）</label>
        <input id="seasonCoef" type="number" step="0.05" value="1.00">
      </div>
      <button class="secondary" id="recalcForecast" style="align-self:flex-end">予測を再計算</button>
    </div>
  </section>

</main>

<script>
/* ===== ユーティリティ ===== */
const fmtDate = d => d.toISOString().slice(0,10);
const fromYmd = s => { const [y,m,dd]=s.split('-').map(Number); return new Date(y,m-1,dd); };
const startOfWeekMon = d => { const nd=new Date(d.getFullYear(),d.getMonth(),d.getDate()); const day=(nd.getDay()+6)%7; nd.setDate(nd.getDate()-day); return nd; };
const addDays = (d,n)=>{ const x=new Date(d); x.setDate(x.getDate()+n); return x; };
const range7 = start => Array.from({length:7},(_,i)=> addDays(start,i));
const STORE_KEY="rasu_v3_records", DEV_KEY="rasu_v3_my_devices";
const load = (k,def)=>{ try{return JSON.parse(localStorage.getItem(k)||JSON.stringify(def));}catch(_){return def;} };
const save = (k,v)=> localStorage.setItem(k, JSON.stringify(v));

/* ===== データ ===== */
let records = load(STORE_KEY, []); // {id,date,name,watt,hours,tariff,kwh,yen,category}
let myDevices = load(DEV_KEY, []);

/* ===== プリセット ===== */
const defaultPresets=[
  {name:"エアコン（冷房）",watt:600,category:"冷暖房"},
  {name:"エアコン（暖房）",watt:900,category:"冷暖房"},
  {name:"冷蔵庫",watt:150,category:"キッチン"},
  {name:"テレビ",watt:100,category:"情報家電"},
  {name:"ゲーミングPC（平均）",watt:400,category:"娯楽・ゲーム"},
  {name:"ドライヤー",watt:1000,category:"その他"}
];
function renderPreset(){
  const sel=document.getElementById('preset'); sel.innerHTML="";
  sel.appendChild(new Option("（プリセットを選択）",""));
  const og1=document.createElement('optgroup'); og1.label="標準プリセット";
  defaultPresets.forEach(p=> og1.appendChild(new Option(`${p.name} / ${p.watt}W`, JSON.stringify(p))));
  sel.appendChild(og1);
  const og2=document.createElement('optgroup'); og2.label="マイ家電（保存済み）";
  myDevices.forEach(p=> og2.appendChild(new Option(`${p.name} / ${p.watt}W`, JSON.stringify(p))));
  sel.appendChild(og2);
}
document.addEventListener('change', e=>{
  if(e.target.id==='preset' && e.target.value){
    try{ const p=JSON.parse(e.target.value);
      document.getElementById('name').value=p.name;
      document.getElementById('watt').value=p.watt;
      document.getElementById('category').value=p.category||"その他";
    }catch(_){}
  }
});
document.getElementById('saveMyDevice').addEventListener('click', ()=>{
  const name=document.getElementById('name').value.trim();
  const watt=parseFloat(document.getElementById('watt').value);
  const category=document.getElementById('category').value||"その他";
  if(!name||!isFinite(watt)) return alert("家電名とW数を入力してください");
  myDevices.push({name,watt,category}); save(DEV_KEY,myDevices); renderPreset(); alert("マイ家電に保存しました！");
});
document.getElementById('clearMyDevice').addEventListener('click', ()=>{
  if(confirm("保存したマイ家電をすべて削除しますか？")){
    myDevices=[]; save(DEV_KEY,myDevices); renderPreset();
  }
});

/* ===== 記録追加 ===== */
document.getElementById('addRecord').addEventListener('click', ()=>{
  const name=(document.getElementById('name').value||"未設定").trim();
  const watt=parseFloat(document.getElementById('watt').value);
  const hours=parseFloat(document.getElementById('hours').value);
  const tariff=parseFloat(document.getElementById('tariff').value);
  let date=document.getElementById('date').value; if(!date){ date=fmtDate(new Date()); document.getElementById('date').value=date; }
  const category=document.getElementById('category').value||"その他";
  if([watt,hours,tariff].some(v=>!isFinite(v))) return alert("数値を正しく入力してください");
  const kwh=(watt*hours)/1000, yen=kwh*tariff;
  const id=Date.now().toString(36)+"_"+Math.random().toString(36).slice(2,8);
  records.push({id,date,name,watt,hours,tariff,kwh,yen,category}); save(STORE_KEY,records); redraw();
});

/* ===== 週ビュー ===== */
let currentWeekStart=startOfWeekMon(new Date());
document.getElementById('prevWeek').addEventListener('click',()=>{ currentWeekStart=addDays(currentWeekStart,-7); redraw(); });
document.getElementById('thisWeek').addEventListener('click',()=>{ currentWeekStart=startOfWeekMon(new Date()); redraw(); });
document.getElementById('nextWeek').addEventListener('click',()=>{ currentWeekStart=addDays(currentWeekStart,7); redraw(); });
document.getElementById('jumpDate').addEventListener('change',e=>{ const d=fromYmd(e.target.value); if(!isFinite(d)) return; currentWeekStart=startOfWeekMon(d); redraw(); });

/* ===== Export / Import ===== */
document.getElementById('exportData').addEventListener('click',()=>{
  const blob=new Blob([JSON.stringify({records,myDevices},null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download="denkidai_weekly_v3.json"; a.click(); URL.revokeObjectURL(url);
});
document.getElementById('importFile').addEventListener('change', e=>{
  const f=e.target.files[0]; if(!f) return; const r=new FileReader();
  r.onload=()=>{ try{ const d=JSON.parse(r.result); if(d.records) records=d.records; if(d.myDevices){ myDevices=d.myDevices; save(DEV_KEY,myDevices); } save(STORE_KEY,records); renderPreset(); redraw(); }catch(err){ alert("読み込みに失敗しました"); } };
  r.readAsText(f);
});

/* ===== 表示系 ===== */
const sum = (list,key)=> list.reduce((s,x)=> s + (x[key]||0), 0);
function getWeekRecords(start){ const days=range7(start).map(fmtDate); return records.filter(r=> days.includes(r.date)); }
function setWeekLabel(){ const a=currentWeekStart, b=addDays(a,6); document.getElementById('weekLabel').textContent=`${fmtDate(a)} 〜 ${fmtDate(b)}`; }
function woW(thisCost,lastCost){
  if(lastCost<=0) return "—";
  const delta=thisCost-lastCost, pct=(delta/lastCost)*100;
  const sign=delta>0?"+":""; return `${sign}${Math.round(pct)}%（${sign}¥${Math.round(delta).toLocaleString("ja-JP")}）`;
}
function forecastNext(start){
  const last=getWeekRecords(addDays(start,-7)), prev=getWeekRecords(addDays(start,-14));
  const base=((sum(last,"yen")+sum(prev,"yen"))/2) || sum(last,"yen") || sum(getWeekRecords(start),"yen");
  const coef=parseFloat(document.getElementById('seasonCoef').value||"1.0")||1.0;
  return base*coef;
}
function renderKpi(){
  const thisW=getWeekRecords(currentWeekStart), lastW=getWeekRecords(addDays(currentWeekStart,-7));
  const kwhThis=sum(thisW,"kwh"), yenThis=sum(thisW,"yen"), yenLast=sum(lastW,"yen");
  document.getElementById('kpiKwh').textContent=kwhThis.toFixed(2);
  document.getElementById('kpiYen').textContent="¥"+Math.round(yenThis).toLocaleString("ja-JP");
  document.getElementById('kpiWoW').textContent=woW(yenThis,yenLast);
  document.getElementById('kpiNext').textContent="¥"+Math.round(forecastNext(currentWeekStart)).toLocaleString("ja-JP");
}
function renderWeekTable(){
  const tbody=document.querySelector('#weekTable tbody'); tbody.innerHTML="";
  range7(currentWeekStart).forEach(d=>{
    const ymd=fmtDate(d); const list=records.filter(r=> r.date===ymd);
    const kwh=sum(list,"kwh"), yen=sum(list,"yen");
    const details=document.createElement('details'); const sumry=document.createElement('summary'); sumry.textContent=list.length?`${list.length} 件の内訳`:"—"; details.appendChild(sumry);
    if(list.length){
      const ul=document.createElement('ul'); ul.className='small';
      list.forEach(x=>{ const li=document.createElement('li'); li.innerHTML=`${escapeHtml(x.name)} / ${x.watt}W×${x.hours}h = ${x.kwh.toFixed(2)}kWh / ¥${Math.round(x.yen).toLocaleString("ja-JP")} <button class="secondary" data-edit="${x.id}">編集</button> <button class="secondary" data-del="${x.id}">削除</button>`; ul.appendChild(li); });
      details.appendChild(ul);
    }
    const tr=document.createElement('tr'); tr.innerHTML=`<td>${ymd}</td><td>${kwh.toFixed(2)}</td><td>¥${Math.round(yen).toLocaleString("ja-JP")}</td><td></td>`; tr.children[3].appendChild(details); tbody.appendChild(tr);
  });
}
document.addEventListener('click', e=>{
  const d=e.target.dataset;
  if(d.del){ records=records.filter(r=> r.id!==d.del); save(STORE_KEY,records); redraw(); }
  if(d.edit){ const rec=records.find(r=> r.id===d.edit); if(!rec) return;
    const name=prompt("家電名",rec.name)??rec.name;
    const watt=+prompt("消費電力(W)",rec.watt)||rec.watt;
    const hours=+prompt("使用時間(h)",rec.hours)||rec.hours;
    const tariff=+prompt("単価(円/kWh)",rec.tariff)||rec.tariff;
    const date=prompt("日付(YYYY-MM-DD)",rec.date)??rec.date;
    const category=prompt("カテゴリー",rec.category||"その他")??(rec.category||"その他");
    const kwh=(watt*hours)/1000, yen=kwh*tariff;
    Object.assign(rec,{name,watt,hours,tariff,date,category,kwh,yen}); save(STORE_KEY,records); redraw();
  }
});
function escapeHtml(s){return (s||"").toString().replace(/[&<>\"']/g,c=>({"&":"&amp;","<":"&lt;","&gt;":"&gt;","\"":"&quot;","'":"&#39;"}[c]));}

/* ===== グラフ（Canvas） ===== */
function drawBarWeek(){
  const days=range7(currentWeekStart).map(fmtDate);
  const data=days.map(d=> Math.round(sum(records.filter(r=>r.date===d),"yen")));
  const canvas=document.getElementById('barWeek'), ctx=canvas.getContext('2d');
  const DPR=window.devicePixelRatio||1, W=canvas.clientWidth, H=canvas.clientHeight; canvas.width=W*DPR; canvas.height=H*DPR; ctx.scale(DPR,DPR);
  ctx.clearRect(0,0,W,H);
  const pad=36, maxY=Math.max(...data,100)||100;
  ctx.strokeStyle="#233043"; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(pad,H-pad); ctx.lineTo(W-pad,H-pad); ctx.lineTo(W-pad,pad); ctx.stroke();
  const n=7, bw=(W-2*pad)/n*0.6, gap=(W-2*pad)/n*0.4;
  data.forEach((v,i)=>{
    const x=pad + i*((W-2*pad)/n) + gap/2, h=(H-2*pad)*(v/maxY);
    ctx.fillStyle=`hsl(${(i*48)%360} 80% 55%)`; ctx.fillRect(x,H-pad-h,bw,h);
    ctx.fillStyle="#9fb3c8"; ctx.font="12px system-ui"; ctx.fillText(["月","火","水","木","金","土","日"][i], x+bw/4, H-pad+16);
  });
  ctx.fillStyle="#9fb3c8";
  for(let t=0;t<=4;t++){ const y=H-pad-(H-2*pad)*t/4; const val=Math.round(maxY*t/4); ctx.fillText("¥"+val.toLocaleString("ja-JP"),6,y+4); ctx.strokeStyle="#233043"; ctx.beginPath(); ctx.moveTo(pad,y); ctx.lineTo(W-pad,y); ctx.stroke(); }
}
function drawBarCompare(){
  const thisCost=sum(getWeekRecords(currentWeekStart),"yen");
  const lastCost=sum(getWeekRecords(addDays(currentWeekStart,-7)),"yen");
  const nextCost=forecastNext(currentWeekStart);
  const labels=["先週","今週","来週(予測)"]; const data=[lastCost,thisCost,nextCost].map(v=>Math.round(v));
  const canvas=document.getElementById('barCompare'), ctx=canvas.getContext('2d');
  const DPR=window.devicePixelRatio||1, W=canvas.clientWidth, H=canvas.clientHeight; canvas.width=W*DPR; canvas.height=H*DPR; ctx.scale(DPR,DPR);
  ctx.clearRect(0,0,W,H);
  const pad=40, maxY=Math.max(...data,100)||100, n=3, bw=(W-2*pad)/n*0.5, gap=(W-2*pad)/n*0.5;
  ctx.strokeStyle="#233043"; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(pad,H-pad); ctx.lineTo(W-pad,H-pad); ctx.lineTo(W-pad,pad); ctx.stroke();
  data.forEach((v,i)=>{
    const x=pad + i*((W-2*pad)/n) + gap/2, h=(H-2*pad)*(v/maxY);
    ctx.fillStyle=["#7aa2ff","#7cffc2","#ffd36e"][i]; ctx.fillRect(x,H-pad-h,bw,h);
    ctx.fillStyle="#e8f0ff"; ctx.font="12px system-ui"; ctx.fillText(labels[i], x, H-pad+16);
    ctx.fillText("¥"+v.toLocaleString("ja-JP"), x, H-pad-h-6);
  });
  ctx.fillStyle="#9fb3c8";
  for(let t=0;t<=4;t++){ const y=H-pad-(H-2*pad)*t/4; const val=Math.round(maxY*t/4); ctx.fillText("¥"+val.toLocaleString("ja-JP"),6,y+4); ctx.strokeStyle="#233043"; ctx.beginPath(); ctx.moveTo(pad,y); ctx.lineTo(W-pad,y); ctx.stroke(); }
}

/* ===== 画面更新 ===== */
function redraw(){
  document.getElementById('date').value ||= fmtDate(new Date());
  document.getElementById('jumpDate').value = fmtDate(new Date());
  setWeekLabel(); renderKpi(); renderWeekTable(); drawBarWeek(); drawBarCompare();
}

/* ===== 初期化 ===== */
(function init(){
  document.getElementById('date').value = fmtDate(new Date());
  document.getElementById('jumpDate').value = fmtDate(new Date());
  renderPreset();
  if(records.length===0){
    const today=new Date();
    const seed=[
      {name:"エアコン（冷房）",watt:600,hours:5,tariff:31,category:"冷暖房",offset:-1},
      {name:"ゲーミングPC",watt:500,hours:3,tariff:31,category:"娯楽・ゲーム",offset:-2},
      {name:"冷蔵庫",watt:150,hours:8,tariff:31,category:"キッチン",offset:-3},
      {name:"照明",watt:30,hours:5,tariff:31,category:"照明",offset:0}
    ];
    seed.forEach(s=>{ const d=fmtDate(addDays(today,s.offset)); const kwh=(s.watt*s.hours)/1000, yen=kwh*s.tariff;
      records.push({id:Date.now().toString(36)+"_"+Math.random().toString(36).slice(2,8),date:d,name:s.name,watt:s.watt,hours:s.hours,tariff:s.tariff,kwh,yen,category:s.category}); });
    save(STORE_KEY,records);
  }
  redraw();
})();
</script>

<script>
/* PWA: Service Worker 登録 */
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=> {
    navigator.serviceWorker.register('./sw.js').catch(console.error);
  });
}
</script>
</body>
</html>
