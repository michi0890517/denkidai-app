<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>電気代アプリ v4（通知/CO₂/時間帯料金/OCR/バッジ）</title>
<link rel="manifest" href="manifest.webmanifest" />
<meta name="theme-color" content="#0b0f14" />
<style>
:root{--bg:#0b0f14;--panel:#111824;--text:#e8f0ff;--muted:#9fb3c8;--accent:#5ad1ff;--accent2:#7cffc2;--border:#233043;--ok:#64f4a3;--warn:#ffd36e;--bad:#ff6b6b}
*{box-sizing:border-box} body{margin:0;background:#0b0f14;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;line-height:1.6;padding-bottom:env(safe-area-inset-bottom)}
header{position:sticky;top:0;z-index:10;padding:16px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,rgba(90,209,255,.08),rgba(124,255,194,.05));backdrop-filter:blur(6px)}
h1{margin:0;font-size:clamp(18px,3.2vw,28px)} .sub{color:var(--muted);font-size:12px}
main{max-width:1200px;margin:0 auto;padding:16px} .grid{display:grid;gap:14px;grid-template-columns:1fr} @media(min-width:1100px){.grid{grid-template-columns:1.2fr 1fr}}
.card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));border:1px solid var(--border);border-radius:14px;padding:14px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end} label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
input,select,button,textarea{background:#0e1520;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px;outline:none}
input:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(90,209,255,.12)}
button{cursor:pointer;border:1px solid transparent;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#001018;font-weight:700}
button.secondary{background:transparent;color:var(--text);border-color:var(--border)}
table{width:100%;border-collapse:collapse;font-size:14px} th,td{border-bottom:1px dashed var(--border);padding:10px;text-align:left} th{color:var(--muted)}
.kpi{display:grid;grid-template-columns:repeat(2,1fr);gap:10px} @media(min-width:640px){.kpi{grid-template-columns:repeat(4,1fr)}}
.kpi .box{background:#0e1520;border:1px solid var(--border);border-radius:12px;padding:12px} .kpi .num{font-size:22px;font-weight:800}
.small{font-size:12px;color:var(--muted)} .tag{padding:4px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px;color:var(--muted);display:inline-block}
.flex-between{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
canvas{width:100%;height:320px;background:#0e1520;border:1px solid var(--border);border-radius:12px;display:block}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--border)}
.stamps{display:flex;gap:6px;flex-wrap:wrap}
.stamp{width:26px;height:26px;display:grid;place-items:center;border:1px solid var(--border);border-radius:6px;background:#0e1520;font-size:12px}
.ok{background:var(--ok);color:#001010}
@media (max-width: 640px){ input,select,button,textarea{font-size:16px} .row{gap:8px} .card{padding:12px}}
summary{cursor:pointer}
hr{border:0;border-top:1px dashed var(--border);margin:8px 0}
</style>
</head>
<body>
<header>
  <h1>電気代アプリ v4 <span class="badge">通知</span> <span class="badge">CO₂</span> <span class="badge">時間帯料金</span> <span class="badge">OCR</span> <span class="badge">バッジ</span></h1>
  <div class="sub">PWA対応（オフラインOK）。21時リマインド / 使いすぎ通知 / CO₂換算 / 時間帯料金 / 請求書OCR / スタンプ＆称号。</div>
</header>

<main class="grid">

  <!-- 入力 -->
  <section class="card">
    <div class="flex-between">
      <h2 style="margin:0">① クイック記録</h2>
      <div class="row">
        <button class="secondary" id="copyYesterday">昨日と同じ</button>
        <button class="secondary" id="dupLast">直近の記録を複製</button>
      </div>
    </div>
    <div class="row">
      <div>
        <label>家電名</label>
        <input id="name" placeholder="例: エアコン（冷房）">
      </div>
      <div>
        <label>消費電力 (W)</label>
        <input id="watt" type="number" inputmode="decimal" placeholder="600">
      </div>
      <div>
        <label>使用時間 (h)</label>
        <input id="hours" type="number" inputmode="decimal" placeholder="1.5">
      </div>
      <div>
        <label>日付</label>
        <input id="date" type="date">
      </div>
      <div>
        <label>開始時刻</label>
        <input id="time" type="time" value="19:00">
      </div>
      <div>
        <label>カテゴリー</label>
        <select id="category">
          <option>冷暖房</option><option>キッチン</option><option>照明</option>
          <option>情報家電</option><option>娯楽・ゲーム</option><option>その他</option>
        </select>
      </div>
      <div>
        <label>CO₂係数 (kg/kWh)</label>
        <input id="co2Factor" type="number" step="0.01" value="0.50">
      </div>
    </div>
    <div class="row">
      <button id="addRecord">この内容で記録（時間帯料金で単価自動）</button>
    </div>
  </section>

  <!-- 時間帯料金 -->
  <section class="card">
    <h2 style="margin:0">② 時間帯料金（TOU）</h2>
    <div class="small">時間帯ごとに単価（円/kWh）を設定。入力の開始時刻で自動適用。</div>
    <div class="row">
      <div><label>昼(07-22)</label><input id="rateDay" type="number" value="31"></div>
      <div><label>夜(22-24)</label><input id="rateNight" type="number" value="24"></div>
      <div><label>深夜(00-07)</label><input id="rateLate" type="number" value="22"></div>
      <button class="secondary" id="saveTOU">保存</button>
    </div>
  </section>

  <!-- KPI -->
  <section class="card">
    <div class="flex-between">
      <h2 style="margin:0">③ 今週の状況</h2>
      <div class="row">
        <button class="secondary" id="prevWeek">＜ 先週</button>
        <button class="secondary" id="thisWeek">今週</button>
        <button class="secondary" id="nextWeek">来週 ＞</button>
        <input id="jumpDate" type="date" title="この日を含む週へジャンプ">
      </div>
    </div>
    <div><span class="tag">週範囲</span> <strong id="weekLabel">—</strong></div>
    <div class="kpi" style="margin-top:10px">
      <div class="box"><div class="small">今週 合計kWh</div><div class="num" id="kpiKwh">0.00</div></div>
      <div class="box"><div class="small">今週 電気代</div><div class="num" id="kpiYen">¥0</div></div>
      <div class="box"><div class="small">今週 CO₂</div><div class="num" id="kpiCO2">0.00 kg</div></div>
      <div class="box"><div class="small">先週比</div><div class="num" id="kpiWoW">—</div></div>
    </div>
  </section>

  <!-- 日別明細 -->
  <section class="card" style="grid-column:1/-1">
    <h2 style="margin:0 0 6px">④ 日別明細（今表示中の週）</h2>
    <table id="weekTable">
      <thead><tr><th>日付</th><th>kWh</th><th>電気代</th><th>CO₂(kg)</th><th>内訳</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- グラフ -->
  <section class="card">
    <h2 style="margin:0 0 6px">⑤ 日別コスト（今週）</h2>
    <canvas id="barWeek"></canvas>
  </section>

  <!-- 通知 -->
  <section class="card">
    <h2 style="margin:0 0 6px">⑥ 通知設定</h2>
    <div class="row">
      <div><label>使いすぎアラート（今日）</label><input id="limitYen" type="number" value="500"></div>
      <div><label>リマインド時刻</label><input id="remindAt" type="time" value="21:00"></div>
      <button class="secondary" id="enableNoti">通知ON</button>
    </div>
    <div class="small">※Web Pushなしのローカル通知。アプリ起動中に有効（PWAでホーム画面運用推奨）。</div>
  </section>

  <!-- OCR 取り込み -->
  <section class="card">
    <h2 style="margin:0 0 6px">⑦ 請求書OCR取り込み（β）</h2>
    <div class="row">
      <input type="file" id="ocrFile" accept="image/*" />
      <button class="secondary" id="runOCR">OCRで読み取り</button>
    </div>
    <div id="ocrOut" class="small" style="margin-top:8px;color:#cfe4ff"></div>
  </section>

  <!-- バッジ & スタンプ -->
  <section class="card">
    <h2 style="margin:0 0 6px">⑧ スタンプ & バッジ</h2>
    <div class="small">毎日入力でスタンプ。3/7/14日連続で称号が増える。</div>
    <div class="stamps" id="stamps"></div>
    <hr>
    <div id="badges" class="small"></div>
  </section>

</main>

<!-- Tesseract.js (OCR) CDN -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>

<script>
/* ===== ユーティリティ ===== */
const fmtDate = d => d.toISOString().slice(0,10);
const fromYmd = s => { if(!s) return new Date(); const [y,m,dd]=s.split('-').map(Number); return new Date(y,m-1,dd); };
const startOfWeekMon = d => { const nd=new Date(d.getFullYear(),d.getMonth(),d.getDate()); const day=(nd.getDay()+6)%7; nd.setDate(nd.getDate()-day); return nd; };
const addDays = (d,n)=>{ const x=new Date(d); x.setDate(x.getDate()+n); return x; };
const range7 = start => Array.from({length:7},(_,i)=> addDays(start,i));
const sum = (list,key)=> list.reduce((s,x)=> s + (x[key]||0), 0);
const escHTML = s => (s||"").toString().replace(/[&<>\"']/g,c=>({"&":"&amp;","<":"&lt;","&gt;":"&gt;","\"":"&quot;","'":"&#39;"}[c]));

/* ===== ストレージ ===== */
const STORE_KEY="rasu_v4_records";
const TOU_KEY="rasu_v4_tou";
const CFG_KEY="rasu_v4_cfg";
const BADGE_KEY="rasu_v4_badges";
const load = (k,def)=>{ try{return JSON.parse(localStorage.getItem(k)||JSON.stringify(def));}catch(_){return def;} };
const save = (k,v)=> localStorage.setItem(k, JSON.stringify(v));

/* ===== データ構造 =====
record: {id,date,time,name,watt,hours,kwh,yen,co2,category,rate}
TOU設定: {day:31, night:24, late:22}
設定: {co2Factor:0.5, limitYen:500, remindAt:"21:00", lastNotiDate:"YYYY-MM-DD"}
バッジ: {streak: n, days: ["YYYY-MM-DD", ...], earned: ["3days","7days",...]}
*/
let records = load(STORE_KEY, []);
let TOU = load(TOU_KEY, {day:31, night:24, late:22});
let CFG = load(CFG_KEY, {co2Factor:0.5, limitYen:500, remindAt:"21:00", lastNotiDate:null});
let BADGE = load(BADGE_KEY, {streak:0, days:[], earned:[]});

/* ===== UI 初期値 ===== */
document.getElementById('date').value = fmtDate(new Date());
document.getElementById('jumpDate').value = fmtDate(new Date());
document.getElementById('rateDay').value = TOU.day;
document.getElementById('rateNight').value = TOU.night;
document.getElementById('rateLate').value = TOU.late;
document.getElementById('co2Factor').value = CFG.co2Factor;
document.getElementById('limitYen').value = CFG.limitYen;
document.getElementById('remindAt').value = CFG.remindAt;

/* ===== 時間帯単価 ===== */
function getRateByTime(hhmm){
  const [h,m] = (hhmm||"00:00").split(":").map(Number);
  const H = (h + (m>=30?0:0)); // ざっくり時単位
  if(H>=7 && H<22) return TOU.day;
  if(H>=22 && H<=23) return TOU.night;
  return TOU.late; // 0-6
}
document.getElementById('saveTOU').addEventListener('click', ()=>{
  TOU.day = +document.getElementById('rateDay').value||TOU.day;
  TOU.night = +document.getElementById('rateNight').value||TOU.night;
  TOU.late = +document.getElementById('rateLate').value||TOU.late;
  CFG.co2Factor = +document.getElementById('co2Factor').value || CFG.co2Factor;
  save(TOU_KEY, TOU); save(CFG_KEY, CFG);
  alert('時間帯料金とCO₂係数を保存しました');
});

/* ===== 記録追加 ===== */
function addRecord(rec){
  records.push(rec); save(STORE_KEY, records);
  updateStreak(rec.date); // スタンプ＆バッジ更新
  redraw(); checkOveruseNotify();
}
document.getElementById('addRecord').addEventListener('click', ()=>{
  const name=(document.getElementById('name').value||"未設定").trim();
  const watt=parseFloat(document.getElementById('watt').value);
  const hours=parseFloat(document.getElementById('hours').value);
  const date=document.getElementById('date').value || fmtDate(new Date());
  const time=document.getElementById('time').value || "19:00";
  const category=document.getElementById('category').value||"その他";
  CFG.co2Factor = +document.getElementById('co2Factor').value || CFG.co2Factor; save(CFG_KEY, CFG);
  if([watt,hours].some(v=>!isFinite(v))) return alert("W数と時間を正しく入力してください");
  const kwh=(watt*hours)/1000;
  const rate = getRateByTime(time);
  const yen = kwh*rate;
  const co2 = kwh*CFG.co2Factor;
  const id=Date.now().toString(36)+"_"+Math.random().toString(36).slice(2,8);
  addRecord({id,date,time,name,watt,hours,kwh,yen,co2,category,rate});
});

/* ===== ショートカット ===== */
document.getElementById('copyYesterday').addEventListener('click', ()=>{
  const ymd = fmtDate(addDays(new Date(), -1));
  const list = records.filter(r=> r.date===ymd);
  if(!list.length) return alert("昨日の記録がありません");
  list.forEach(r=>{
    const c = {...r, id: Date.now().toString(36)+"_"+Math.random().toString(36).slice(2,8), date: fmtDate(new Date())};
    addRecord(c);
  });
});
document.getElementById('dupLast').addEventListener('click', ()=>{
  const last = records[records.length-1];
  if(!last) return alert("まだ記録がありません");
  const c = {...last, id: Date.now().toString(36)+"_"+Math.random().toString(36).slice(2,8), date: fmtDate(new Date())};
  addRecord(c);
});

/* ===== 週ビュー ===== */
let currentWeekStart=startOfWeekMon(new Date());
function getWeekRecords(start){ const d=range7(start).map(fmtDate); return records.filter(r=> d.includes(r.date)); }
function setWeekLabel(){ const a=currentWeekStart, b=addDays(a,6); document.getElementById('weekLabel').textContent=`${fmtDate(a)} 〜 ${fmtDate(b)}`; }
document.getElementById('prevWeek').addEventListener('click',()=>{ currentWeekStart=addDays(currentWeekStart,-7); redraw(); });
document.getElementById('thisWeek').addEventListener('click',()=>{ currentWeekStart=startOfWeekMon(new Date()); redraw(); });
document.getElementById('nextWeek').addEventListener('click',()=>{ currentWeekStart=addDays(currentWeekStart,7); redraw(); });
document.getElementById('jumpDate').addEventListener('change',e=>{ const d=fromYmd(e.target.value); currentWeekStart=startOfWeekMon(d); redraw(); });

/* ===== KPI ===== */
function woW(thisCost,lastCost){
  if(lastCost<=0) return "—";
  const delta=thisCost-lastCost, pct=(delta/lastCost)*100;
  const sign=delta>0?"+":""; return `${sign}${Math.round(pct)}%（${sign}¥${Math.round(delta).toLocaleString("ja-JP")}）`;
}
function renderKpi(){
  const thisW=getWeekRecords(currentWeekStart), lastW=getWeekRecords(addDays(currentWeekStart,-7));
  const kwhThis=sum(thisW,"kwh"), yenThis=sum(thisW,"yen"), co2This=sum(thisW,"co2");
  const yenLast=sum(lastW,"yen");
  document.getElementById('kpiKwh').textContent=kwhThis.toFixed(2);
  document.getElementById('kpiYen').textContent="¥"+Math.round(yenThis).toLocaleString("ja-JP");
  document.getElementById('kpiCO2').textContent=co2This.toFixed(2)+" kg";
  document.getElementById('kpiWoW').textContent=woW(yenThis,yenLast);
}

/* ===== テーブル ===== */
function renderWeekTable(){
  const tbody=document.querySelector('#weekTable tbody'); tbody.innerHTML="";
  range7(currentWeekStart).forEach(d=>{
    const ymd=fmtDate(d); const list=records.filter(r=> r.date===ymd);
    const kwh=sum(list,"kwh"), yen=sum(list,"yen"), co2=sum(list,"co2");
    const details=document.createElement('details'); const sumry=document.createElement('summary');
    sumry.textContent=list.length?`${list.length} 件の内訳`:"—"; details.appendChild(sumry);
    if(list.length){
      const ul=document.createElement('ul'); ul.className='small';
      list.forEach(x=>{
        const li=document.createElement('li');
        li.innerHTML=`${escHTML(x.name)} / ${x.watt}W×${x.hours}h @¥${x.rate}/kWh = ${x.kwh.toFixed(2)}kWh / ¥${Math.round(x.yen).toLocaleString("ja-JP")} / CO₂ ${x.co2.toFixed(2)}kg 
        <button class="secondary" data-edit="${x.id}">編集</button> <button class="secondary" data-del="${x.id}">削除</button>`;
        ul.appendChild(li);
      });
      details.appendChild(ul);
    }
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${ymd}</td><td>${kwh.toFixed(2)}</td><td>¥${Math.round(yen).toLocaleString("ja-JP")}</td><td>${co2.toFixed(2)}</td><td></td>`;
    tr.children[4].appendChild(details); tbody.appendChild(tr);
  });
}
document.addEventListener('click', e=>{
  const d=e.target.dataset;
  if(d.del){ records=records.filter(r=> r.id!==d.del); save(STORE_KEY,records); redraw(); }
  if(d.edit){
    const rec=records.find(r=> r.id===d.edit); if(!rec) return;
    const name=prompt("家電名",rec.name)??rec.name;
    const watt=+prompt("消費電力(W)",rec.watt)||rec.watt;
    const hours=+prompt("使用時間(h)",rec.hours)||rec.hours;
    const rate=+prompt("単価(円/kWh)",rec.rate)||rec.rate;
    const date=prompt("日付(YYYY-MM-DD)",rec.date)??rec.date;
    const time=prompt("開始時刻(HH:MM)",rec.time)??rec.time;
    const category=prompt("カテゴリー",rec.category||"その他")??(rec.category||"その他");
    const kwh=(watt*hours)/1000; const yen=kwh*rate; const co2=kwh*CFG.co2Factor;
    Object.assign(rec,{name,watt,hours,rate,date,time,category,kwh,yen,co2}); save(STORE_KEY,records); redraw();
  }
});

/* ===== グラフ（Canvas） ===== */
function drawBarWeek(){
  const days=range7(currentWeekStart).map(fmtDate);
  const data=days.map(d=> Math.round(sum(records.filter(r=>r.date===d),"yen")));
  const canvas=document.getElementById('barWeek'), ctx=canvas.getContext('2d');
  const DPR=window.devicePixelRatio||1, W=canvas.clientWidth, H=canvas.clientHeight; canvas.width=W*DPR; canvas.height=H*DPR; ctx.scale(DPR,DPR);
  ctx.clearRect(0,0,W,H);
  const pad=36, maxY=Math.max(...data,100)||100;
  ctx.strokeStyle="#233043"; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(pad,H-pad); ctx.lineTo(W-pad,H-pad); ctx.lineTo(W-pad,pad); ctx.stroke();
  const n=7, bw=(W-2*pad)/n*0.6, gap=(W-2*pad)/n*0.4;
  data.forEach((v,i)=>{
    const x=pad + i*((W-2*pad)/n) + gap/2, h=(H-2*pad)*(v/maxY);
    ctx.fillStyle=`hsl(${(i*48)%360} 80% 55%)`; ctx.fillRect(x,H-pad-h,bw,h);
    ctx.fillStyle="#9fb3c8"; ctx.font="12px system-ui"; ctx.fillText(["月","火","水","木","金","土","日"][i], x+bw/4, H-pad+16);
  });
  ctx.fillStyle="#9fb3c8";
  for(let t=0;t<=4;t++){ const y=H-pad-(H-2*pad)*t/4; const val=Math.round(maxY*t/4); ctx.fillText("¥"+val.toLocaleString("ja-JP"),6,y+4); ctx.strokeStyle="#233043"; ctx.beginPath(); ctx.moveTo(pad,y); ctx.lineTo(W-pad,y); ctx.stroke(); }
}

/* ===== 通知（ローカル） ===== */
async function requestNoti(){
  if(!("Notification" in window)) return alert("通知に未対応のブラウザです");
  const p = await Notification.requestPermission();
  if(p!=="granted") alert("通知が許可されていません");
}
document.getElementById('enableNoti').addEventListener('click', async ()=>{
  CFG.limitYen = +document.getElementById('limitYen').value || CFG.limitYen;
  CFG.remindAt = document.getElementById('remindAt').value || CFG.remindAt;
  save(CFG_KEY, CFG);
  await requestNoti();
  scheduleReminderTick();
  alert("通知を有効化しました（このタブ/アプリが開いている間に動作します）");
});
function notify(title, body){ try{ new Notification(title, {body}); }catch(_){ console.log(title, body); } }
function checkOveruseNotify(){
  const today = fmtDate(new Date());
  const spent = sum(records.filter(r=> r.date===today), "yen");
  if(spent >= CFG.limitYen){
    const key = "over_"+today+"_"+CFG.limitYen;
    if(sessionStorage.getItem(key)) return; // 同日同閾値で1回だけ
    notify("使いすぎアラート", `今日の合計が¥${Math.round(spent)}を超えました（閾値¥${CFG.limitYen}）`);
    sessionStorage.setItem(key,"1");
  }
}
function scheduleReminderTick(){
  // 1分ごとに現在時刻を見て、指定時刻±1分なら通知（重複防止あり）
  if(window.__remindTimer) clearInterval(window.__remindTimer);
  window.__remindTimer = setInterval(()=>{
    const [hh,mm] = (CFG.remindAt||"21:00").split(":").map(Number);
    const now = new Date(); const today=fmtDate(now);
    if(CFG.lastNotiDate===today) return;
    if(now.getHours()===hh && Math.abs(now.getMinutes()-mm)<=1){
      notify("今日の入力リマインド","今日の電気代、つけ忘れてない？");
      CFG.lastNotiDate=today; save(CFG_KEY, CFG);
    }
  }, 60*1000);
}

/* ===== OCR ===== */
document.getElementById('runOCR').addEventListener('click', async ()=>{
  const file = document.getElementById('ocrFile').files?.[0];
  if(!file) return alert("画像を選択してください");
  document.getElementById('ocrOut').textContent = "読み取り中…";
  try{
    const { data:{ text } } = await Tesseract.recognize(file, 'jpn+eng', { logger: m=>{} });
    document.getElementById('ocrOut').textContent = "OCR結果: \n"+text.slice(0,1000);
    // 簡易抽出: 日付 / kWh / 円
    const dateMatch = text.match(/(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})/);
    const kwhMatch = text.match(/([\d\.]+)\s*kWh/i);
    const yenMatch = text.match(/¥\s*([\d,]+)/) || text.match(/合計\s*([\d,]+)\s*円/);
    const date = dateMatch ? `${dateMatch[1]}-${String(dateMatch[2]).padStart(2,'0')}-${String(dateMatch[3]).padStart(2,'0')}` : fmtDate(new Date());
    const kwh = kwhMatch ? parseFloat(kwhMatch[1]) : null;
    const yen = yenMatch ? parseInt(yenMatch[1].replace(/,/g,''),10) : null;
    if(kwh||yen){
      const rate = (kwh && yen) ? (yen/kwh) : getRateByTime("19:00");
      const co2 = (kwh||0) * CFG.co2Factor;
      addRecord({id:cryptoId(), date, time:"19:00", name:"請求書OCR", watt:0, hours:0, kwh:kwh||0, yen: yen||((kwh||0)*rate), co2, category:"その他", rate});
      alert("OCRから1件登録しました（必要なら編集で調整）");
    }else{
      alert("金額やkWhが読み取れませんでした。結果を確認して手入力してください。");
    }
  }catch(e){
    console.error(e); alert("OCRに失敗しました");
    document.getElementById('ocrOut').textContent = "読み取りに失敗";
  }
});
function cryptoId(){ return Date.now().toString(36)+"_"+Math.random().toString(36).slice(2,8); }

/* ===== スタンプ & バッジ ===== */
function updateStreak(dateStr){
  // 一度でもその日に記録があればスタンプ付与
  const dset = new Set(BADGE.days);
  if(!dset.has(dateStr)){ BADGE.days.push(dateStr); }
  BADGE.days.sort();
  // 直近から連続日数を計算
  let streak=0; let ptr = new Date();
  for(;;){
    const ymd = fmtDate(ptr);
    if(BADGE.days.includes(ymd)){ streak++; ptr=addDays(ptr,-1); }
    else break;
  }
  BADGE.streak = streak;
  // バッジ付与
  const earned = new Set(BADGE.earned);
  if(streak>=3) earned.add("3日連続"); 
  if(streak>=7) earned.add("7日連続"); 
  if(streak>=14) earned.add("14日連続");
  BADGE.earned = [...earned];
  save(BADGE_KEY, BADGE);
  renderBadges();
}
function renderBadges(){
  // スタンプ（直近14日）
  const box=document.getElementById('stamps'); box.innerHTML="";
  for(let i=13;i>=0;i--){
    const ymd=fmtDate(addDays(new Date(), -i));
    const div=document.createElement('div');
    div.className="stamp"+(BADGE.days.includes(ymd)?" ok":"");
    div.textContent = new Date(ymd).getDate();
    box.appendChild(div);
  }
  // バッジ一覧
  const bd=document.getElementById('badges');
  bd.innerHTML = "称号: " + (BADGE.earned.length? BADGE.earned.join(" / ") : "なし") + `　現在連続: ${BADGE.streak}日`;
}

/* ===== 再描画 ===== */
function redraw(){
  setWeekLabel(); renderKpi(); renderWeekTable(); drawBarWeek(); renderBadges();
}

/* ===== 初期デモ投入（初回のみ） ===== */
(function init(){
  if(records.length===0){
    const today=new Date();
    const seed=[
      {name:"エアコン（冷房）",watt:600,hours:5,rate:TOU.day,offset:-1},
      {name:"ゲーミングPC",watt:500,hours:3,rate:TOU.day,offset:-2},
      {name:"冷蔵庫",watt:150,hours:8,rate:TOU.late,offset:-3},
      {name:"照明",watt:30,hours:5,rate:TOU.night,offset:0},
    ];
    seed.forEach(s=>{
      const d=fmtDate(addDays(today,s.offset));
      const kwh=(s.watt*s.hours)/1000, yen=kwh*s.rate, co2=kwh*CFG.co2Factor;
      records.push({id:cryptoId(), date:d, time:"19:00", name:s.name, watt:s.watt, hours:s.hours, kwh, yen, co2, category:"その他", rate:s.rate});
      BADGE.days.push(d);
    });
    save(STORE_KEY,records); save(BADGE_KEY,BADGE);
  }
  scheduleReminderTick();
  redraw();
})();

/* ===== PWA SW 登録（既存の sw.js を使用） ===== */
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=> {
    navigator.serviceWorker.register('./sw.js').catch(console.error);
  });
}
</script>
</body>
</html>
